trigger: none  # Manual trigger only

pool:
  vmImage: 'ubuntu-latest'

variables:
  environment: 'demo-env'

stages:
# === Stage 1: SAST with Snyk ===
- stage: SAST
  displayName: "SAST - Static Analysis with Snyk"
  jobs:
  - job: snykScan
    displayName: "Run Snyk SAST Scan"
    continueOnError: true
    steps:
    - script: echo "üîç Starting Snyk CLI setup and authentication"

    - script: |
        curl https://static.snyk.io/cli/latest/snyk-linux -o snyk
        chmod +x snyk
        sudo mv snyk /usr/local/bin
      displayName: "Install Snyk CLI"

    - script: |
        snyk auth $(SNYK_TOKEN)
      displayName: "Authenticate Snyk CLI"

    - script: |
        echo "üìÇ No real code to scan ‚Äî running test as demo"
        snyk test || echo "‚ö†Ô∏è No project files found, test skipped"
      displayName: "Run Snyk Test"

    - script: |
        echo "üì° Sending snapshot to Snyk dashboard..."
        snyk monitor || echo "‚ö†Ô∏è Monitor failed or no manifest, continuing anyway"
      displayName: "Send to Snyk Dashboard"

# === Stage 2: Manual Approval (Simulated) ===
- stage: Approval
  displayName: "Approval Stage"
  dependsOn: SAST
  condition: succeededOrFailed()
  jobs:
  - job: manualApproval
    displayName: "Simulated Manual Approval"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "‚è≥ Waiting for manual approval simulation..."
        sleep 5
        echo "‚úÖ Approval simulated"
      displayName: "Simulate Approval Delay"

# === Stage 3: Deploy (Demo) ===
- stage: Deploy
  displayName: "Deploy Stage"
  dependsOn: Approval
  condition: succeededOrFailed()
  jobs:
  - job: deployJob
    displayName: "Demo Deployment Job"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: echo "üöÄ Demo Deployment Step - No actual deployment done"
      displayName: "Demo Deploy Step"
